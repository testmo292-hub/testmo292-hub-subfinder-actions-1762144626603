name: Subfinder Reconnaissance

on:
  workflow_dispatch:
    inputs:
      target_domain:
        description: 'Target domain for subdomain enumeration'
        required: true
        default: 'example.com'
      output_format:
        description: 'Output format (json, csv, txt)'
        required: false
        default: 'txt'
      session_id:
        description: 'Unique session identifier for this execution'
        required: true

jobs:
  subfinder-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install Subfinder
      run: |
        go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest

    - name: Run Subfinder
      run: |
        mkdir -p results
        echo "Starting subfinder scan for ${{ github.event.inputs.target_domain }}" > results/scan_log.txt
        echo "Session ID: ${{ github.event.inputs.session_id }}" >> results/scan_log.txt
        echo "Timestamp: $(date)" >> results/scan_log.txt
        subfinder -d ${{ github.event.inputs.target_domain }} -o results/subdomains.${{ github.event.inputs.output_format }} 2>> results/scan_log.txt || echo "Subfinder completed with exit code $?" >> results/scan_log.txt
        echo "" >> results/scan_log.txt
        echo "=== SUBFINDER OUTPUT ===" >> results/scan_log.txt
        cat results/subdomains.${{ github.event.inputs.output_format }} >> results/scan_log.txt 2>/dev/null || echo "No subdomains file found or file is empty" >> results/scan_log.txt
        echo "" >> results/scan_log.txt
        echo "=== DIRECTORY LISTING ===" >> results/scan_log.txt
        ls -la results/ >> results/scan_log.txt
        echo "" >> results/scan_log.txt
        echo "=== FILE SIZES ===" >> results/scan_log.txt
        du -h results/* >> results/scan_log.txt 2>/dev/null || echo "No files to check sizes" >> results/scan_log.txt
        # Ensure subdomains file exists even if empty
        touch results/subdomains.${{ github.event.inputs.output_format }}

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: subfinder-results-${{ github.event.inputs.session_id }}
        path: results/
        retention-days: 7